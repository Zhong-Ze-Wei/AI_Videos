<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼æ¼”é©¾é©¶èˆ± - ä¸“ä¸šå·¥ä½œæµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #030712; color: #F9FAFB; }
        .step-section { background-color: rgba(17, 24, 39, 0.7); backdrop-filter: blur(10px); border: 1px solid #374151; }
        .control-btn { transition: all 0.3s ease; }
        .control-btn:disabled { background-color: #4B5563; cursor: not-allowed; }
        .brief-card, .segment-card { background-color: #1F2937; border: 1px solid #4B5563; }
        .prompt-text { scrollbar-width: thin; scrollbar-color: #4B5563 #1F2937; }
        .prompt-text::-webkit-scrollbar { width: 8px; }
        .prompt-text::-webkit-scrollbar-track { background: #1F2937; }
        .prompt-text::-webkit-scrollbar-thumb { background-color: #4B5563; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        .segment-nav-item { transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .segment-nav-item:hover { background-color: #374151; border-left-color: #4338CA; }
        .segment-nav-item.active { background-color: #1E1B4B; border-left-color: #4F46E5; }
        #segment-detail-view { transition: opacity 0.3s ease-in-out; }

        #main-preview-image { transition: opacity 0.3s ease-in-out; }
        .gallery-thumbnail { cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease-in-out; opacity: 0.6; }
        .gallery-thumbnail:hover { opacity: 1; transform: scale(1.05); }
        .gallery-thumbnail.active { border-color: #4F46E5; opacity: 1; transform: scale(1.1); }

        .editable-container textarea { background-color: #111827; border: 1px solid #4f46e5; resize: vertical; }
        .edit-btn-group { display: none; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-screen-2xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-black text-white tracking-tight">å¯¼æ¼”é©¾é©¶èˆ±</h1>
            <p class="text-xl text-gray-400 mt-3">ä¸“ä¸šåˆ›ä½œå·¥ä½œæµ</p>
        </header>

        <!-- æ–°å¢ï¼šåˆ›ä½œå†å² -->
        <section id="history-section" class="step-section p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">åˆ›ä½œå†å²</h2>
            <div id="task-history-list" class="space-y-3 max-h-48 overflow-y-auto">
                <p id="history-loading" class="text-gray-400">æ­£åœ¨åŠ è½½å†å²é¡¹ç›®...</p>
            </div>
        </section>

        <!-- æ­¥éª¤ä¸€ï¼šå…¨å±€åˆ›æ„ç®€æŠ¥ -->
        <section id="step1" class="step-section p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬ä¸€æ­¥ï¼šå…¨å±€åˆ›æ„ç®€æŠ¥</h2>
            <p class="text-gray-400 mb-6">è¾“å…¥æ ¸å¿ƒå®šä½è¯ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†çš„åˆ›ä½œåŸºçŸ³ã€‚è¿™æ˜¯ä¿è¯é£æ ¼å’Œäººç‰©ç»Ÿä¸€çš„å…³é”®ã€‚</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="style-keyword" class="block mb-2 text-sm font-medium text-gray-300">ç¾æœ¯é£æ ¼</label>
                    <input type="text" id="style-keyword" placeholder="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹æ°´å¢¨é£" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label for="character-keyword" class="block mb-2 text-sm font-medium text-gray-300">è§’è‰²æè¿°</label>
                    <input type="text" id="character-keyword" placeholder="ä¾‹å¦‚ï¼šæœºæ¢°ä¹‰ä½“ä¾¦æ¢" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label for="world-keyword" class="block mb-2 text-sm font-medium text-gray-300">æ ¸å¿ƒä¸»é¢˜</label>
                    <input type="text" id="world-keyword" placeholder="ä¾‹å¦‚ï¼šç§‘æŠ€ä¸äººæ€§çš„å†²çª" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                </div>
            </div>
            <button id="generate-brief-btn" class="control-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆåˆ›æ„ç®€æŠ¥</button>
            <div id="brief-display" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6"></div>
        </section>

        <!-- æ­¥éª¤äºŒï¼šæ•…äº‹å¤§çº²ä¸ç»†èŠ‚ -->
        <section id="step2" class="step-section p-6 rounded-xl mb-8 hidden">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬äºŒæ­¥ï¼šæ•…äº‹å¤§çº²ä¸ç»†èŠ‚</h2>
            <p class="text-gray-400 mb-6">åŸºäºå·²ç¡®å®šçš„åˆ›æ„ç®€æŠ¥ï¼Œè¾“å…¥æ•…äº‹ä¸»é¢˜ï¼ŒAIå°†ç”ŸæˆåŒ…å«å®Œæ•´å‰§æœ¬å’Œæç¤ºè¯çš„6ä¸ªå­æ®µè½ã€‚</p>
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" id="theme-input" placeholder="è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜ (å¦‚ï¼šè¿½æŸ¥ä¸€ä¸ªå¤åˆ¶äººå¤±è¸ªæ¡ˆ)" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <button id="generate-story-btn" class="control-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆæ•…äº‹å‰§æœ¬</button>
            </div>
            <div id="story-display" class="grid grid-cols-1 lg:grid-cols-4 gap-8 mt-6 hidden">
                <div id="segment-detail-view" class="lg:col-span-3 space-y-6"></div>
                <div id="segment-navigation" class="lg:col-span-1 space-y-2"></div>
            </div>
        </section>

        <!-- æ­¥éª¤ä¸‰ï¼šè§†è§‰é¢„è§ˆ -->
        <section id="step3" class="step-section p-6 rounded-xl hidden">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬ä¸‰æ­¥ï¼šè§†è§‰é¢„è§ˆ</h2>
            <p class="text-gray-400 mb-6">é¢„è§ˆæ ¹æ®æç¤ºè¯ç”Ÿæˆçš„å…³é”®å¸§å›¾åƒï¼Œæ£€æŸ¥é£æ ¼ã€äººç‰©çš„ä¸€è‡´æ€§ï¼Œç¡®è®¤æ— è¯¯åå†è¿›è¡Œæœ€ç»ˆçš„è§†é¢‘ç”Ÿæˆã€‚</p>
            <button id="generate-preview-btn" class="control-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆå…¨éƒ¨é¢„è§ˆå›¾</button>

            <div id="preview-gallery" class="mt-6 hidden grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 flex flex-col gap-4">
                    <div id="main-preview-wrapper" class="bg-black rounded-lg aspect-video overflow-hidden flex items-center justify-center">
                        <img id="main-preview-image" src="" alt="ä¸»é¢„è§ˆå›¾" class="max-w-full max-h-full object-contain">
                    </div>
                    <div id="main-preview-details" class="brief-card p-4 rounded-lg">
                        <h4 id="preview-segment-title" class="font-bold text-lg text-purple-400 mb-2"></h4>
                        <p id="preview-segment-action" class="text-gray-300 text-sm mb-3"></p>
                        <h5 class="font-semibold text-gray-400 text-xs mb-1">æœ€ç»ˆå›¾åƒæç¤ºè¯:</h5>
                        <p id="preview-segment-prompt" class="prompt-text text-xs text-gray-400 h-16 overflow-y-auto bg-gray-800 p-2 rounded"></p>
                    </div>
                </div>
                <div id="right-preview-panel" class="lg:col-span-2 flex flex-col gap-4">
                </div>
            </div>
        </section>
    </div>

    <!-- æœ€ç»ˆç¡®è®¤å¼¹çª— -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 rounded-xl w-full max-w-4xl h-[90vh] flex flex-col border border-gray-700">
            <div class="p-4 border-b border-gray-700"><h2 class="text-2xl font-bold text-white">æœ€ç»ˆç¡®è®¤</h2><p class="text-gray-400">è¯·åœ¨ç”Ÿæˆå›¾åƒå‰ï¼Œæœ€åä¸€æ¬¡æ£€æŸ¥å¹¶ä¿®æ”¹æ‚¨çš„åˆ›æ„ç®€æŠ¥å’Œæç¤ºè¯ã€‚</p></div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6">
                <div>
                    <h3 class="text-xl font-semibold text-indigo-400 mb-3">å…¨å±€åˆ›æ„ç®€æŠ¥</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-300">ç¾æœ¯é£æ ¼</label><textarea id="modal-style" class="w-full h-24 p-2 text-sm rounded-md bg-gray-800 border border-gray-600"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-300">è§’è‰²æè¿°</label><textarea id="modal-character" class="w-full h-24 p-2 text-sm rounded-md bg-gray-800 border border-gray-600"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-300">æ ¸å¿ƒä¸»é¢˜</label><textarea id="modal-world" class="w-full h-24 p-2 text-sm rounded-md bg-gray-800 border border-gray-600"></textarea></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">å›¾åƒæç¤ºè¯ (6å¹•)</h3>
                    <div id="modal-prompts" class="space-y-4"></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end gap-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-md">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="control-btn px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-md">ç¡®è®¤å¹¶ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- å…¨å±€çŠ¶æ€ ---
    let globalBrief = {};
    let storyData = {};
    let activeChart = null;
    let previewImageUrls = [];

    // --- DOM å…ƒç´  ---
    const taskHistoryList = document.getElementById('task-history-list');
    const historyLoading = document.getElementById('history-loading');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const generateBriefBtn = document.getElementById('generate-brief-btn');
    const briefDisplay = document.getElementById('brief-display');
    const generateStoryBtn = document.getElementById('generate-story-btn');
    const storyDisplay = document.getElementById('story-display');
    const detailView = document.getElementById('segment-detail-view');
    const navigation = document.getElementById('segment-navigation');
    const generatePreviewBtn = document.getElementById('generate-preview-btn');
    const previewGallery = document.getElementById('preview-gallery');
    const mainPreviewImage = document.getElementById('main-preview-image');
    const rightPreviewPanel = document.getElementById('right-preview-panel');
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const previewSegmentTitle = document.getElementById('preview-segment-title');
    const previewSegmentAction = document.getElementById('preview-segment-action');
    const previewSegmentPrompt = document.getElementById('preview-segment-prompt');

    // --- API è°ƒç”¨å‡½æ•° (å·²ä¿®æ­£) ---
    async function apiCall(endpoint, method = 'POST', body = null, button = null) {
        let originalText = '';
        if(button) {
            button.disabled = true;
            originalText = button.textContent;
            button.textContent = 'å¤„ç†ä¸­...';
        }
        try {
            const config = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (body) {
                config.body = JSON.stringify(body);
            }
            const response = await fetch(`http://127.0.0.1:8000${endpoint}`, config);
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯');
            }
            return await response.json();
        } catch (error) {
            alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            return null;
        } finally {
            if(button) {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
    }

    // --- ç¼–è¾‘åŠŸèƒ½ ---
    function makeEditable(container, dataObject, key) {
        const p = container.querySelector('p');
        const editBtn = container.querySelector('.edit-btn');
        const btnGroup = container.querySelector('.edit-btn-group');
        const textarea = document.createElement('textarea');
        textarea.className = 'w-full p-2 text-sm rounded-md';
        textarea.value = p.innerText;
        const confirmBtn = btnGroup.querySelector('.confirm-btn');
        const cancelBtn = btnGroup.querySelector('.cancel-btn');
        editBtn.addEventListener('click', () => {
            textarea.style.height = `${p.offsetHeight + 20}px`;
            container.insertBefore(textarea, p);
            p.style.display = 'none';
            editBtn.style.display = 'none';
            btnGroup.style.display = 'flex';
        });
        cancelBtn.addEventListener('click', () => {
            container.removeChild(textarea);
            p.style.display = 'block';
            editBtn.style.display = 'inline-flex';
            btnGroup.style.display = 'none';
        });
        confirmBtn.addEventListener('click', () => {
            const newValue = textarea.value;
            dataObject[key] = newValue;
            p.innerHTML = newValue.replace(/\n/g, '<br>');
            container.removeChild(textarea);
            p.style.display = 'block';
            editBtn.style.display = 'inline-flex';
            btnGroup.style.display = 'none';
        });
    }

    function createEditableHTML(title, content, color, dataKey) {
        return `<div class="brief-card p-4 rounded-lg fade-in editable-container" data-key="${dataKey}"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-lg ${color}">${title}</h3><button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button><div class="edit-btn-group space-x-2"><button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button><button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button></div></div><p class="text-gray-300 text-sm">${content.replace(/\n/g, '<br>')}</p></div>`;
    }

    // --- æ­¥éª¤ä¸€ ---
    async function handleGenerateBrief() {
        const keywords = { style: document.getElementById('style-keyword').value, character: document.getElementById('character-keyword').value, world: document.getElementById('world-keyword').value };
        if (!keywords.style || !keywords.character || !keywords.world) { alert('è¯·å¡«å†™å…¨éƒ¨ä¸‰ä¸ªæ ¸å¿ƒå®šä½è¯ï¼'); return; }
        const result = await apiCall('/generate_brief', 'POST', keywords, generateBriefBtn);
        if (result) { globalBrief = result; renderBrief(globalBrief); }
    }

    function renderBrief(brief) {
        briefDisplay.innerHTML = `${createEditableHTML('ç¾æœ¯é£æ ¼', brief.style, 'text-indigo-400', 'style')}${createEditableHTML('è§’è‰²æè¿°', brief.character, 'text-green-400', 'character')}${createEditableHTML('æ ¸å¿ƒä¸»é¢˜', brief.world, 'text-amber-400', 'world')}`;
        briefDisplay.querySelectorAll('.editable-container').forEach(c => makeEditable(c, globalBrief, c.dataset.key));
        step2.classList.remove('hidden');
        step2.classList.add('fade-in');
    }

    // --- æ­¥éª¤äºŒ ---
    async function handleGenerateStory() {
        const theme = document.getElementById('theme-input').value;
        if (!theme) { alert('è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜ï¼'); return; }
        const result = await apiCall('/generate_story_details', 'POST', { brief: globalBrief, theme: theme }, generateStoryBtn);
        if (result) { storyData = result; renderStory(storyData); }
    }

    function renderStory(story) {
        storyDisplay.classList.remove('hidden');
        renderNavigation(story.segments);
        updateDetailView(story.segments[0].id);
        step3.classList.remove('hidden');
        step3.classList.add('fade-in');
    }

    function renderNavigation(segments) {
        navigation.innerHTML = '';
        segments.forEach(segment => {
            const navItem = document.createElement('div');
            navItem.className = 'segment-nav-item p-3 rounded-md cursor-pointer';
            navItem.dataset.id = segment.id;
            navItem.innerHTML = `<h4 class="font-bold text-white">${segment.id}. ${segment.title}</h4>`;
            navItem.addEventListener('click', () => updateDetailView(segment.id));
            navigation.appendChild(navItem);
        });
    }

    function updateDetailView(segmentId) {
        const segment = storyData.segments.find(s => s.id === segmentId);
        if (!segment) return;
        document.querySelectorAll('.segment-nav-item').forEach(item => item.classList.toggle('active', parseInt(item.dataset.id) === segmentId));
        detailView.style.opacity = 0;
        setTimeout(() => {
            detailView.innerHTML = `<div class="brief-card p-6 rounded-lg"><div class="editable-container" data-key="action"><div class="flex justify-between items-center mb-3"><h3 class="text-2xl font-bold text-white">${segment.id}. ${segment.title}</h3><button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button><div class="edit-btn-group space-x-2"><button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button><button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button></div></div><p class="text-gray-300 leading-relaxed">${segment.action}</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="brief-card p-4 rounded-lg space-y-4"><h4 class="font-semibold text-gray-200 text-lg border-b border-gray-600 pb-2">æ•°æ®åˆ†æå°</h4>${createDataBar('å™äº‹å¼ åŠ›', segment.analytics.tension, 'bg-indigo-500')}${createDataBar('è§†è§‰å¤æ‚åº¦', segment.analytics.complexity, 'bg-green-500')}${createDataBar('å™äº‹èŠ‚å¥', segment.analytics.pacing, 'bg-amber-500')}<div><h5 class="font-semibold text-gray-300 mb-2 text-center">æƒ…æ„Ÿå…‰è°±</h5><div class="h-48"><canvas id="detail-chart"></canvas></div></div></div><div class="brief-card p-4 rounded-lg"><h4 class="font-semibold text-gray-200 text-lg border-b border-gray-600 pb-2">AIç”ŸæˆæŒ‡ä»¤</h4><div class="editable-container mt-4" data-key="firstFramePrompt"><div class="flex justify-between items-center mb-2"><h5 class="font-semibold text-gray-300">ğŸ–¼ï¸ å›¾åƒæç¤ºè¯</h5><button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button><div class="edit-btn-group space-x-2"><button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button><button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button></div></div><p class="prompt-text text-sm text-gray-400 h-24 overflow-y-auto bg-gray-800 p-2 rounded">${segment.firstFramePrompt}</p></div><div class="editable-container mt-4" data-key="videoPrompt"><div class="flex justify-between items-center mb-2"><h5 class="font-semibold text-gray-300">ğŸ¥ è§†é¢‘æç¤ºè¯</h5><button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button><div class="edit-btn-group space-x-2"><button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button><button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button></div></div><p class="prompt-text text-sm text-gray-400 h-24 overflow-y-auto bg-gray-800 p-2 rounded">${segment.videoPrompt}</p></div></div></div>`;
            detailView.querySelectorAll('.editable-container').forEach(c => makeEditable(c, segment, c.dataset.key));
            if (activeChart) activeChart.destroy();
            const ctx = document.getElementById('detail-chart').getContext('2d');
            activeChart = new Chart(ctx, { type: 'radar', data: { labels: Object.keys(segment.analytics.emotion), datasets: [{ label: 'æƒ…æ„Ÿ', data: Object.values(segment.analytics.emotion), backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1.5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { angleLines: { color: '#4B5563' }, grid: { color: '#4B5563' }, pointLabels: { color: '#D1D5DB', font: { size: 12 } }, suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } } } });
            detailView.style.opacity = 1;
        }, 300);
    }

    function createDataBar(label, value, colorClass) {
        const percentage = (value / 10) * 100;
        return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-300">${label}</span><span class="text-sm font-bold text-white">${value.toFixed(1)}</span></div><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
    }

    // --- æ­¥éª¤ä¸‰ ---
    function openConfirmationModal() {
        document.getElementById('modal-style').value = globalBrief.style;
        document.getElementById('modal-character').value = globalBrief.character;
        document.getElementById('modal-world').value = globalBrief.world;
        const promptsContainer = document.getElementById('modal-prompts');
        promptsContainer.innerHTML = '';
        storyData.segments.forEach(segment => {
            promptsContainer.innerHTML += `<div><label class="block text-sm font-medium text-gray-300">ç¬¬ ${segment.id} å¹•: ${segment.title}</label><textarea data-segment-id="${segment.id}" class="w-full h-20 p-2 text-sm rounded-md bg-gray-800 border border-gray-600">${segment.firstFramePrompt}</textarea></div>`;
        });
        confirmationModal.classList.remove('hidden');
    }

    function closeConfirmationModal() { confirmationModal.classList.add('hidden'); }

    async function confirmAndGenerateImages() {
        globalBrief.style = document.getElementById('modal-style').value;
        globalBrief.character = document.getElementById('modal-character').value;
        globalBrief.world = document.getElementById('modal-world').value;
        document.querySelectorAll('#modal-prompts textarea').forEach(textarea => {
            const segment = storyData.segments.find(s => s.id === parseInt(textarea.dataset.segmentId));
            if (segment) segment.firstFramePrompt = textarea.value;
        });

        renderBrief(globalBrief);
        renderStory(storyData);

        closeConfirmationModal();

        generatePreviewBtn.textContent = `ç”Ÿæˆå…¨éƒ¨é¢„è§ˆå›¾ (${storyData.segments.length}å¼ )`;
        const payload = { title: storyData.title, brief: globalBrief, segments: storyData.segments };
        const result = await apiCall('/generate_images', 'POST', payload, generatePreviewBtn);
        if (result && result.image_urls) renderPreviews(result.image_urls);
    }

    function createPreviewBriefCardHTML(title, content, color) {
        return `<div class="brief-card p-3 rounded-lg h-28 flex flex-col"><h4 class="font-bold text-sm ${color} mb-2 text-center border-b border-gray-700 pb-1">${title}</h4><p class="prompt-text text-gray-300 text-xs leading-relaxed flex-grow overflow-y-auto">${content.replace(/\n/g, '<br>')}</p></div>`;
    }

    function renderPreviews(urls) {
        previewImageUrls = urls;
        previewGallery.classList.remove('hidden');

        const panel = document.getElementById('right-preview-panel');
        const thumbnailContainer = document.createElement('div');
        thumbnailContainer.className = 'grid grid-cols-3 gap-3 col-span-3';

        panel.innerHTML = `
            ${createPreviewBriefCardHTML('ç¾æœ¯é£æ ¼', globalBrief.style, 'text-indigo-400')}
            ${createPreviewBriefCardHTML('è§’è‰²æè¿°', globalBrief.character, 'text-green-400')}
            ${createPreviewBriefCardHTML('æ ¸å¿ƒä¸»é¢˜', globalBrief.world, 'text-amber-400')}
            <div class="col-span-3 text-center text-gray-400 text-sm font-bold tracking-widest">- å…³é”®å¸§é¢„è§ˆ -</div>
        `;

        mainPreviewImage.src = urls[0];

        urls.forEach((url, index) => {
            const segment = storyData.segments[index];
            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'gallery-thumbnail bg-gray-800 rounded-lg overflow-hidden relative aspect-video';
            thumbWrapper.dataset.index = index;

            const img = document.createElement('img');
            img.src = url;
            img.className = 'w-full h-full object-cover';
            img.alt = `é¢„è§ˆå›¾ ${index + 1}`;
            img.onerror = function() { this.onerror=null; this.src='https://placehold.co/160x90/030712/F9FAFB?text=Error'; };

            const titleOverlay = document.createElement('div');
            titleOverlay.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs text-center py-1';
            titleOverlay.textContent = `${segment.id}. ${segment.title}`;

            thumbWrapper.appendChild(img);
            thumbWrapper.appendChild(titleOverlay);
            thumbnailContainer.appendChild(thumbWrapper);

            if (index === 0) {
                thumbWrapper.classList.add('active');
                updatePreviewDetails(0);
            }
            thumbWrapper.addEventListener('click', () => switchMainImage(thumbWrapper));
        });
        panel.appendChild(thumbnailContainer);
    }

    function switchMainImage(clickedThumb) {
        const currentActive = document.querySelector('#right-preview-panel .gallery-thumbnail.active');
        if (currentActive === clickedThumb) return;
        if (currentActive) currentActive.classList.remove('active');
        clickedThumb.classList.add('active');
        mainPreviewImage.style.opacity = 0;

        const imageIndex = parseInt(clickedThumb.dataset.index);
        updatePreviewDetails(imageIndex);

        setTimeout(() => {
            mainPreviewImage.src = previewImageUrls[imageIndex];
            mainPreviewImage.style.opacity = 1;
        }, 300);
    }

    function updatePreviewDetails(index) {
        const segment = storyData.segments[index];
        if(segment) {
            previewSegmentTitle.textContent = `${segment.id}. ${segment.title}`;
            previewSegmentAction.textContent = segment.action;
            previewSegmentPrompt.textContent = segment.firstFramePrompt;
        }
    }

    // --- æ–°å¢ï¼šé¡¹ç›®å†å² ---
    async function loadTaskHistory() {
        const tasks = await apiCall('/tasks', 'GET');
        if (tasks && tasks.length > 0) {
            historyLoading.style.display = 'none';
            taskHistoryList.innerHTML = '';
            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'flex justify-between items-center p-3 bg-gray-800 rounded-lg';
                taskItem.innerHTML = `<span class="text-gray-300">${task.title}</span><button data-task-name="${task.folder_name}" class="load-task-btn control-btn text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded">åŠ è½½</button>`;
                taskHistoryList.appendChild(taskItem);
            });
            document.querySelectorAll('.load-task-btn').forEach(btn => {
                btn.addEventListener('click', handleLoadTask);
            });
        } else {
            historyLoading.textContent = 'æš‚æ— å†å²é¡¹ç›®';
        }
    }

    async function handleLoadTask(event) {
        const taskName = event.target.dataset.taskName;
        const projectData = await apiCall(`/task/${taskName}`, 'GET', null, event.target);
        if (projectData) {
            // æ¢å¤æ‰€æœ‰çŠ¶æ€
            globalBrief = projectData.brief;
            storyData = projectData.story;
            previewImageUrls = projectData.images.image_urls;

            // æ¸²æŸ“æ‰€æœ‰æ­¥éª¤
            renderBrief(globalBrief);
            renderStory(storyData);
            renderPreviews(previewImageUrls);
        }
    }

    // --- äº‹ä»¶ç»‘å®š ---
    generateBriefBtn.addEventListener('click', handleGenerateBrief);
    generateStoryBtn.addEventListener('click', handleGenerateStory);
    generatePreviewBtn.addEventListener('click', openConfirmationModal);
    modalConfirmBtn.addEventListener('click', confirmAndGenerateImages);
    modalCancelBtn.addEventListener('click', closeConfirmationModal);

    // --- é¡µé¢åˆå§‹åŒ– ---
    loadTaskHistory();
});
</script>
</body>
</ht