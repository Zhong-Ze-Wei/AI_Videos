<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼æ¼”é©¾é©¶èˆ± - ä¸“ä¸šå·¥ä½œæµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #030712;
            color: #F9FAFB;
            background-image: radial-gradient(at 20% 20%, hsla(212, 96%, 15%, 0.3) 0px, transparent 50%),
                              radial-gradient(at 80% 20%, hsla(284, 96%, 15%, 0.2) 0px, transparent 50%),
                              radial-gradient(at 20% 80%, hsla(180, 96%, 15%, 0.2) 0px, transparent 50%),
                              radial-gradient(at 80% 80%, hsla(34, 96%, 15%, 0.2) 0px, transparent 50%);
            background-attachment: fixed;
        }
        .step-section { background-color: rgba(17, 24, 39, 0.7); backdrop-filter: blur(10px); border: 1px solid #374151; }
        .control-btn { transition: all 0.3s ease; }
        .control-btn:disabled { background-color: #4B5563; cursor: not-allowed; }
        .brief-card, .segment-card { background-color: #1F2937; border: 1px solid #4B5563; }
        .prompt-text { scrollbar-width: thin; scrollbar-color: #4B5563 #1F2937; }
        .prompt-text::-webkit-scrollbar { width: 8px; }
        .prompt-text::-webkit-scrollbar-track { background: #1F2937; }
        .prompt-text::-webkit-scrollbar-thumb { background-color: #4B5563; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .segment-nav-item { transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .segment-nav-item:hover { background-color: #374151; border-left-color: #4338CA; }
        .segment-nav-item.active { background-color: #1E1B4B; border-left-color: #4F46E5; }
        .gallery-thumbnail { cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease-in-out; opacity: 0.6; }
        .gallery-thumbnail:hover { opacity: 1; transform: scale(1.05); }
        .gallery-thumbnail.active { border-color: #4F46E5; opacity: 1; transform: scale(1.1); }
        .entry-card { background-color: rgba(31, 41, 55, 0.8); border: 1px solid #374151; transition: all 0.2s ease-in-out; cursor: pointer; overflow: hidden; position: relative; background-size: cover; background-position: center; }
        .entry-card::before { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: linear-gradient(to top, rgba(17, 24, 39, 0.9) 0%, rgba(17, 24, 39, 0.5) 60%, transparent 100%); opacity: 0; transition: opacity 0.3s ease; }
        .entry-card.has-bg::before { opacity: 1; }
        .entry-card:hover { transform: translateY(-5px); border-color: #4F46E5; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1), 0 4px 6px -2px rgba(79, 70, 229, 0.05); }
        .active-project-card { border-color: #6366F1; transform: translateY(-5px) scale(1.02); box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        .card-content { position: relative; z-index: 1; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-screen-2xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-black text-white tracking-tight">å¯¼æ¼”é©¾é©¶èˆ±</h1>
            <p class="text-xl text-gray-400 mt-3">ä¸“ä¸šåˆ›ä½œå·¥ä½œæµ</p>
        </header>

        <div id="breadcrumb-bar" class="hidden mb-4 text-sm text-gray-400">
            <a href="#entry-center-section" class="hover:text-white cursor-pointer">å…¥å£ä¸­å¿ƒ</a>
            <span class="mx-2">/</span>
            <span id="current-project-title" class="font-bold text-white"></span>
        </div>

        <section id="entry-center-section" class="step-section p-6 rounded-xl mb-8">
            <h2 class="text-3xl font-bold text-white mb-6 border-b border-gray-700 pb-4">å…¥å£ä¸­å¿ƒ</h2>
            <div id="task-history-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <p id="history-loading" class="text-gray-400 col-span-full">æ­£åœ¨åŠ è½½é¡¹ç›®...</p>
            </div>
        </section>

        <div id="workflow-container" class="hidden space-y-8">
            <section id="step1" class="step-section p-6 rounded-xl">
                <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬ä¸€æ­¥ï¼šå…¨å±€åˆ›æ„ç®€æŠ¥</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-6">
                    <div> <label for="style-keyword" class="block mb-2 text-sm font-medium text-gray-300">ç¾æœ¯é£æ ¼</label> <input type="text" id="style-keyword" placeholder="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹æ°´å¢¨é£" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"> </div>
                    <div> <label for="character-keyword" class="block mb-2 text-sm font-medium text-gray-300">è§’è‰²æè¿°</label> <input type="text" id="character-keyword" placeholder="ä¾‹å¦‚ï¼šæœºæ¢°ä¹‰ä½“ä¾¦æ¢" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"> </div>
                    <div> <label for="world-keyword" class="block mb-2 text-sm font-medium text-gray-300">æ ¸å¿ƒä¸»é¢˜</label> <input type="text" id="world-keyword" placeholder="ä¾‹å¦‚ï¼šç§‘æŠ€ä¸äººæ€§çš„å†²çª" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"> </div>
                </div>
                <button id="generate-brief-btn" class="control-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆåˆ›æ„ç®€æŠ¥</button>
                <div id="brief-display" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6"></div>
            </section>

            <section id="step2" class="step-section p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬äºŒæ­¥ï¼šæ•…äº‹å¤§çº²ä¸ç»†èŠ‚</h2>
                <div class="flex flex-col sm:flex-row gap-4 my-6">
                    <input type="text" id="theme-input" placeholder="è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜ (å¦‚ï¼šè¿½æŸ¥ä¸€ä¸ªå¤åˆ¶äººå¤±è¸ªæ¡ˆ)" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <button id="generate-story-btn" class="control-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆæ•…äº‹å‰§æœ¬</button>
                </div>
                <div id="story-display" class="grid grid-cols-1 lg:grid-cols-4 gap-8 mt-6 hidden">
                    <div id="segment-detail-view" class="lg:col-span-3 space-y-6"></div>
                    <div id="segment-navigation" class="lg:col-span-1 space-y-2"></div>
                </div>
            </section>

            <section id="step3" class="step-section p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬ä¸‰æ­¥ï¼šè§†è§‰é¢„è§ˆ</h2>
                <button id="generate-preview-btn" class="control-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg mt-6">ç”Ÿæˆå…¨éƒ¨é¢„è§ˆå›¾</button>
                <div id="preview-gallery" class="mt-6 hidden grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3 flex flex-col gap-4">
                        <div id="main-preview-wrapper" class="bg-black rounded-lg aspect-video overflow-hidden flex items-center justify-center"> <img id="main-preview-image" src="" alt="ä¸»é¢„è§ˆå›¾" class="max-w-full max-h-full object-contain"> </div>
                        <div id="main-preview-details" class="brief-card p-4 rounded-lg">
                            <h4 id="preview-segment-title" class="font-bold text-lg text-purple-400 mb-2"></h4>
                            <p id="preview-segment-action" class="text-gray-300 text-sm mb-3"></p>
                            <h5 class="font-semibold text-gray-400 text-xs mb-1">æœ€ç»ˆå›¾åƒæç¤ºè¯:</h5>
                            <p id="preview-segment-prompt" class="prompt-text text-xs text-gray-400 h-16 overflow-y-auto bg-gray-800 p-2 rounded"></p>
                        </div>
                    </div>
                    <div id="right-preview-panel" class="lg:col-span-2 flex flex-col gap-4"></div>
                </div>
            </section>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-900 rounded-xl w-full max-w-4xl h-[90vh] flex flex-col border border-gray-700">
            <div class="p-4 border-b border-gray-700"><h2 class="text-2xl font-bold text-white">æœ€ç»ˆç¡®è®¤</h2><p class="text-gray-400">è¯·åœ¨ç”Ÿæˆå›¾åƒå‰ï¼Œæœ€åä¸€æ¬¡æ£€æŸ¥å¹¶ä¿®æ”¹æ‚¨çš„åˆ›æ„ç®€æŠ¥å’Œæç¤ºè¯ã€‚</p></div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6">
                <div>
                    <h3 class="text-xl font-semibold text-indigo-400 mb-3">å…¨å±€åˆ›æ„ç®€æŠ¥</h3>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-300">ç¾æœ¯é£æ ¼</label><textarea id="modal-style" class="w-full h-24 p-2 text-sm rounded-md bg-gray-800 border border-gray-600"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-300">è§’è‰²æè¿°</label><textarea id="modal-character" class="w-full h-24 p-2 text-sm rounded-md bg-gray-800 border border-gray-600"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-300">æ ¸å¿ƒä¸»é¢˜</label><textarea id="modal-world" class="w-full h-24 p-2 text-sm rounded-md bg-gray-800 border border-gray-600"></textarea></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">å›¾åƒæç¤ºè¯ (6å¹•)</h3>
                    <div id="modal-prompts" class="space-y-4"></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-end gap-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-md">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="control-btn px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-md">ç¡®è®¤å¹¶ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- å…¨å±€å˜é‡ ---
    let globalBrief = {}; let storyData = {}; let activeChart = null; let previewImageResults = [];

    // --- DOM å…ƒç´ è·å– (å®Œæ•´ä¸”æ­£ç¡®) ---
    const entryCenterSection = document.getElementById('entry-center-section');
    const workflowContainer = document.getElementById('workflow-container');
    const taskHistoryList = document.getElementById('task-history-list');
    const historyLoading = document.getElementById('history-loading');
    const breadcrumbBar = document.getElementById('breadcrumb-bar');
    const currentProjectTitle = document.getElementById('current-project-title');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const generateBriefBtn = document.getElementById('generate-brief-btn');
    const briefDisplay = document.getElementById('brief-display');
    const generateStoryBtn = document.getElementById('generate-story-btn');
    const storyDisplay = document.getElementById('story-display');
    const detailView = document.getElementById('segment-detail-view');
    const navigation = document.getElementById('segment-navigation');
    const generatePreviewBtn = document.getElementById('generate-preview-btn');
    const previewGallery = document.getElementById('preview-gallery');
    const mainPreviewImage = document.getElementById('main-preview-image');
    const rightPreviewPanel = document.getElementById('right-preview-panel');
    const previewSegmentTitle = document.getElementById('preview-segment-title');
    const previewSegmentAction = document.getElementById('preview-segment-action');
    const previewSegmentPrompt = document.getElementById('preview-segment-prompt');
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    // --- äº¤äº’å‡½æ•° ---
    function showWorkflowView(title) {
        currentProjectTitle.textContent = title;
        breadcrumbBar.classList.remove('hidden');
        workflowContainer.classList.remove('hidden');
        setTimeout(() => {
            workflowContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }

    function startNewWorkflow() {
        globalBrief = {}; storyData = {}; previewImageResults = [];
        briefDisplay.innerHTML = '';
        storyDisplay.classList.add('hidden');
        previewGallery.classList.add('hidden');
        document.getElementById('style-keyword').value = '';
        document.getElementById('character-keyword').value = '';
        document.getElementById('world-keyword').value = '';
        document.getElementById('theme-input').value = '';
        step2.classList.add('hidden');
        step3.classList.add('hidden');
        document.querySelectorAll('.active-project-card').forEach(c => c.classList.remove('active-project-card'));
        const newCard = taskHistoryList.querySelector('.new-project-card');
        if (newCard) newCard.classList.add('active-project-card');
        showWorkflowView('æ–°çš„åˆ›ä½œ');
    }

    // --- API è°ƒç”¨ ---
    async function apiCall(endpoint, method = 'POST', body = null, button = null) {
        let originalText = '';
        if (button) { button.disabled = true; originalText = button.textContent; button.textContent = 'å¤„ç†ä¸­...'; }
        try {
            const config = { method: method, headers: { 'Content-Type': 'application/json' }, };
            if (body) { config.body = JSON.stringify(body); }
            const response = await fetch(endpoint, config);
            if (!response.ok) { const err = await response.json(); throw new Error(err.detail || 'æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯'); }
            return await response.json();
        } catch (error) {
            alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            return null;
        } finally {
            if (button) { button.disabled = false; button.textContent = originalText; }
        }
    }

    // --- ç¼–è¾‘åŠŸèƒ½ ---
    function createEditableHTML(title, content, color, dataKey) {
        return `<div class="brief-card p-4 rounded-lg fade-in editable-container" data-key="${dataKey}">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg ${color}">${title}</h3>
                        <button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button>
                        <div class="edit-btn-group space-x-2 hidden">
                            <button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button>
                            <button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <p class="text-gray-300 text-sm">${content.replace(/\n/g, '<br>')}</p>
                </div>`;
    }

    function makeEditable(container, dataObject, key) {
        const p = container.querySelector('p');
        const editBtn = container.querySelector('.edit-btn');
        const btnGroup = container.querySelector('.edit-btn-group');
        const textarea = document.createElement('textarea');
        textarea.className = 'w-full p-2 text-sm rounded-md bg-gray-800 border border-indigo-500';
        textarea.value = p.innerText;
        const confirmBtn = btnGroup.querySelector('.confirm-btn');
        const cancelBtn = btnGroup.querySelector('.cancel-btn');
        const enterEditMode = () => {
            textarea.style.height = `${p.offsetHeight + 24}px`;
            container.insertBefore(textarea, p);
            p.classList.add('hidden');
            editBtn.classList.add('hidden');
            btnGroup.classList.remove('hidden');
        };
        const exitEditMode = () => {
            if(container.contains(textarea)) { container.removeChild(textarea); }
            p.classList.remove('hidden');
            editBtn.classList.remove('hidden');
            btnGroup.classList.add('hidden');
        };
        editBtn.addEventListener('click', enterEditMode);
        cancelBtn.addEventListener('click', exitEditMode);
        confirmBtn.addEventListener('click', () => {
            const newValue = textarea.value;
            dataObject[key] = newValue;
            p.innerHTML = newValue.replace(/\n/g, '<br>');
            exitEditMode();
        });
    }

    // --- å·¥ä½œæµæ­¥éª¤å‡½æ•° ---
    async function handleGenerateBrief() {
        storyDisplay.classList.add('hidden'); step2.classList.add('hidden'); previewGallery.classList.add('hidden'); step3.classList.add('hidden');
        storyData = {}; previewImageResults = [];
        const keywords = { style: document.getElementById('style-keyword').value, character: document.getElementById('character-keyword').value, world: document.getElementById('world-keyword').value };
        if (!keywords.style || !keywords.character || !keywords.world) { alert('è¯·å¡«å†™å…¨éƒ¨ä¸‰ä¸ªæ ¸å¿ƒå®šä½è¯ï¼'); return; }
        const result = await apiCall('/generate_brief', 'POST', keywords, generateBriefBtn);
        if (result) { globalBrief = result; renderBrief(globalBrief); }
    }

    function renderBrief(brief) {
        briefDisplay.innerHTML = `${createEditableHTML('ç¾æœ¯é£æ ¼', brief.style, 'text-indigo-400', 'style')}${createEditableHTML('è§’è‰²æè¿°', brief.character, 'text-green-400', 'character')}${createEditableHTML('æ ¸å¿ƒä¸»é¢˜', brief.world, 'text-amber-400', 'world')}`;
        briefDisplay.querySelectorAll('.editable-container').forEach(c => makeEditable(c, globalBrief, c.dataset.key));
        step2.classList.remove('hidden'); step2.classList.add('fade-in');
    }

    async function handleGenerateStory() {
        previewGallery.classList.add('hidden');
        step3.classList.add('hidden');
        previewImageResults = [];
        step3.classList.remove('fade-in-initialized');

        const theme = document.getElementById('theme-input').value;
        if (!theme) {
            alert('è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜ï¼');
            return;
        }

        // --- PREPARATION ---
        const button = generateStoryBtn;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'ç”Ÿæˆä¸­...';

        // Reset and prepare UI elements
        storyData = { title: '', segments: [] };
        detailView.innerHTML = '';
        navigation.innerHTML = ''; // Clear previous results before starting
        storyDisplay.classList.remove('hidden');

        // Show Step 3 placeholder
        if (!step3.classList.contains('fade-in-initialized')) {
            step3.classList.remove('hidden');
            step3.classList.add('fade-in');
            step3.classList.add('fade-in-initialized');
        }

        // --- STREAM PROCESSING (CORRECTED LOGIC) ---
        try {
            const response = await fetch('/generate_story_details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brief: globalBrief, theme: theme })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                for (const line of lines) {
                    if (line.trim() === '') continue;

                    try {
                        const jsonData = JSON.parse(line);

                        if (jsonData.error) {
                            throw new Error(jsonData.error);
                        }

                        // Handle title data
                        if (jsonData.title && !jsonData.id) {
                            storyData.title = jsonData.title;
                            // Optionally, update a title element on the page here
                        }
                        // Handle segment data
                        else if (jsonData.id) {
                            // Add segment to our data object
                            storyData.segments.push(jsonData);
                            storyData.segments.sort((a, b) => a.id - b.id);

                            // --- SURGICAL DOM UPDATE ---
                            // 1. Create and append the new navigation item directly
                            const navItem = document.createElement('div');
                            navItem.className = 'segment-nav-item p-3 rounded-md cursor-pointer';
                            navItem.dataset.id = jsonData.id;
                            navItem.innerHTML = `<h4 class="font-bold text-white">${jsonData.id}. ${jsonData.title}</h4>`;
                            navItem.addEventListener('click', () => updateDetailView(jsonData.id));
                            navigation.appendChild(navItem);

                            // 2. Update the detail view to show this new segment immediately
                            updateDetailView(jsonData.id);
                        }
                    } catch (e) {
                        console.error("Failed to parse or process stream line:", line, e);
                    }
                }
            }
        } catch (error) {
            alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
        } finally {
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    function renderStory(story) {
        renderNavigation(story.segments);
        if (story.segments && story.segments.length > 0) {
            const activeNavItem = navigation.querySelector('.segment-nav-item.active');
            let segmentIdToShow = activeNavItem ? parseInt(activeNavItem.dataset.id) : story.segments[story.segments.length - 1].id;
            if (story.segments.some(s => s.id === segmentIdToShow)) {
                updateDetailView(segmentIdToShow);
            }
            step3.classList.remove('hidden');
            step3.classList.add('fade-in');
        }
    }

    function renderNavigation(segments) {
        navigation.innerHTML = '';
        (segments || []).forEach(segment => {
            const navItem = document.createElement('div');
            navItem.className = 'segment-nav-item p-3 rounded-md cursor-pointer';
            navItem.dataset.id = segment.id;
            navItem.innerHTML = `<h4 class="font-bold text-white">${segment.id}. ${segment.title}</h4>`;
            navItem.addEventListener('click', () => updateDetailView(segment.id));
            navigation.appendChild(navItem);
        });
    }

    function updateDetailView(segmentId) {
        const segment = storyData.segments.find(s => s.id === segmentId);
        if (!segment) return;
        document.querySelectorAll('.segment-nav-item').forEach(item => item.classList.toggle('active', parseInt(item.dataset.id) === segmentId));
        detailView.style.opacity = 0;
        setTimeout(() => {
            detailView.innerHTML = `<div class="brief-card p-6 rounded-lg">
                    <div class="editable-container" data-key="action">
                        <div class="flex justify-between items-center mb-3"><h3 class="text-2xl font-bold text-white">${segment.id}. ${segment.title}</h3><button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button><div class="edit-btn-group space-x-2 hidden"><button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button><button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button></div></div>
                        <p class="text-gray-300 leading-relaxed">${segment.action}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="brief-card p-4 rounded-lg space-y-4">
                        <h4 class="font-semibold text-gray-200 text-lg border-b border-gray-600 pb-2">æ•°æ®åˆ†æå°</h4>
                        ${createDataBar('å™äº‹å¼ åŠ›', segment.analytics.tension, 'bg-indigo-500')}
                        ${createDataBar('è§†è§‰å¤æ‚åº¦', segment.analytics.complexity, 'bg-green-500')}
                        ${createDataBar('å™äº‹èŠ‚å¥', segment.analytics.pacing, 'bg-amber-500')}
                        <div><h5 class="font-semibold text-gray-300 mb-2 text-center">æƒ…æ„Ÿå…‰è°±</h5><div class="h-48"><canvas id="detail-chart"></canvas></div></div>
                    </div>
                    <div class="brief-card p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-200 text-lg border-b border-gray-600 pb-2">AIç”ŸæˆæŒ‡ä»¤</h4>
                        <div class="editable-container mt-4" data-key="firstFramePrompt">
                            <div class="flex justify-between items-center mb-2"><h5 class="font-semibold text-gray-300">ğŸ–¼ï¸ å›¾åƒæç¤ºè¯</h5><button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button><div class="edit-btn-group space-x-2 hidden"><button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button><button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button></div></div>
                            <p class="prompt-text text-sm text-gray-400 h-24 overflow-y-auto bg-gray-800 p-2 rounded">${segment.firstFramePrompt}</p>
                        </div>
                        <div class="editable-container mt-4" data-key="videoPrompt">
                            <div class="flex justify-between items-center mb-2"><h5 class="font-semibold text-gray-300">ğŸ¥ è§†é¢‘æç¤ºè¯</h5><button class="edit-btn text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded">ç¼–è¾‘</button><div class="edit-btn-group space-x-2 hidden"><button class="confirm-btn text-xs bg-green-600 hover:bg-green-500 px-2 py-1 rounded">ç¡®è®¤</button><button class="cancel-btn text-xs bg-red-600 hover:bg-red-500 px-2 py-1 rounded">å–æ¶ˆ</button></div></div>
                            <p class="prompt-text text-sm text-gray-400 h-24 overflow-y-auto bg-gray-800 p-2 rounded">${segment.videoPrompt}</p>
                        </div>
                    </div>
                </div>`;
            detailView.querySelectorAll('.editable-container').forEach(c => makeEditable(c, segment, c.dataset.key));
            if (activeChart) activeChart.destroy();
            const ctx = document.getElementById('detail-chart').getContext('2d');
            activeChart = new Chart(ctx, { type: 'radar', data: { labels: Object.keys(segment.analytics.emotion), datasets: [{ label: 'æƒ…æ„Ÿ', data: Object.values(segment.analytics.emotion), backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1.5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { angleLines: { color: '#4B5563' }, grid: { color: '#4B5563' }, pointLabels: { color: '#D1D5DB', font: { size: 12 } }, suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } } } });
            detailView.style.opacity = 1;
        }, 300);
    }

    function createDataBar(label, value, colorClass) {
        const percentage = (value / 10) * 100;
        return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-300">${label}</span><span class="text-sm font-bold text-white">${(value || 0).toFixed(1)}</span></div><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
    }

    function openConfirmationModal() {
        if (!storyData.segments || storyData.segments.length === 0) { alert('è¯·å…ˆç”Ÿæˆæ•…äº‹å‰§æœ¬ï¼'); return; }
        document.getElementById('modal-style').value = globalBrief.style;
        document.getElementById('modal-character').value = globalBrief.character;
        document.getElementById('modal-world').value = globalBrief.world;
        const promptsContainer = document.getElementById('modal-prompts');
        promptsContainer.innerHTML = '';
        storyData.segments.forEach(segment => { promptsContainer.innerHTML += `<div><label class="block text-sm font-medium text-gray-300">ç¬¬ ${segment.id} å¹•: ${segment.title}</label><textarea data-segment-id="${segment.id}" class="w-full h-20 p-2 text-sm rounded-md bg-gray-800 border border-gray-600">${segment.firstFramePrompt}</textarea></div>`; });
        confirmationModal.classList.remove('hidden');
    }

    function closeConfirmationModal() { confirmationModal.classList.add('hidden'); }

    async function confirmAndGenerateImages() {
        globalBrief.style = document.getElementById('modal-style').value;
        globalBrief.character = document.getElementById('modal-character').value;
        globalBrief.world = document.getElementById('modal-world').value;
        document.querySelectorAll('#modal-prompts textarea').forEach(textarea => { const segment = storyData.segments.find(s => s.id === parseInt(textarea.dataset.segmentId)); if (segment) segment.firstFramePrompt = textarea.value; });
        renderBrief(globalBrief); renderStory(storyData); closeConfirmationModal();
        generatePreviewBtn.textContent = `ç”Ÿæˆå…¨éƒ¨é¢„è§ˆå›¾ (${storyData.segments.length}å¼ )`;
        const payload = { title: storyData.title, brief: globalBrief, segments: storyData.segments };
        const result = await apiCall('/generate_images', 'POST', payload, generatePreviewBtn);
        if (result && result.image_urls) renderPreviews(result.image_urls);
    }

    function createPreviewBriefCardHTML(title, content, color) { return `<div class="brief-card p-3 rounded-lg h-28 flex flex-col"><h4 class="font-bold text-sm ${color} mb-2 text-center border-b border-gray-700 pb-1">${title}</h4><p class="prompt-text text-gray-300 text-xs leading-relaxed flex-grow overflow-y-auto">${content.replace(/\n/g, '<br>')}</p></div>`; }

    function renderPreviews(results) {
        previewImageResults = results;
        previewGallery.classList.remove('hidden');
        previewGallery.classList.add('fade-in');
        const panel = rightPreviewPanel;
        const thumbnailContainer = document.createElement('div');
        thumbnailContainer.className = 'grid grid-cols-3 gap-3 col-span-3';
        panel.innerHTML = ` ${createPreviewBriefCardHTML('ç¾æœ¯é£æ ¼', globalBrief.style, 'text-indigo-400')} ${createPreviewBriefCardHTML('è§’è‰²æè¿°', globalBrief.character, 'text-green-400')} ${createPreviewBriefCardHTML('æ ¸å¿ƒä¸»é¢˜', globalBrief.world, 'text-amber-400')} <div class="col-span-3 text-center text-gray-400 text-sm font-bold tracking-widest">- å…³é”®å¸§é¢„è§ˆ -</div> `;
        mainPreviewImage.src = results.length > 0 ? results[0] : '';
        results.forEach((result, index) => {
            const segment = storyData.segments[index];
            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'gallery-thumbnail bg-gray-800 rounded-lg overflow-hidden relative aspect-video';
            thumbWrapper.dataset.index = index;
            const img = document.createElement('img');
            img.src = result; img.className = 'w-full h-full object-cover';
            img.alt = `é¢„è§ˆå›¾ ${index + 1}`;
            img.onerror = function () { this.onerror = null; this.src = 'https://placehold.co/160x90/030712/F9FAFB?text=Error'; };
            const titleOverlay = document.createElement('div');
            titleOverlay.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs text-center py-1';
            titleOverlay.textContent = segment ? `${segment.id}. ${segment.title}` : `åœºæ™¯ ${index + 1}`;
            thumbWrapper.appendChild(img); thumbWrapper.appendChild(titleOverlay);
            thumbnailContainer.appendChild(thumbWrapper);
            if (index === 0) { thumbWrapper.classList.add('active'); updatePreviewDetails(0); }
            thumbWrapper.addEventListener('click', () => switchMainImage(thumbWrapper));
        });
        panel.appendChild(thumbnailContainer);
    }

    function switchMainImage(clickedThumb) {
        document.querySelectorAll('#right-preview-panel .gallery-thumbnail.active').forEach(t => t.classList.remove('active'));
        clickedThumb.classList.add('active');
        mainPreviewImage.style.opacity = 0;
        const imageIndex = parseInt(clickedThumb.dataset.index);
        updatePreviewDetails(imageIndex);
        setTimeout(() => {
            mainPreviewImage.src = previewImageResults[imageIndex];
            mainPreviewImage.style.opacity = 1;
        }, 300);
    }

    function updatePreviewDetails(index) {
        const segment = storyData.segments[index];
        if (segment) {
            previewSegmentTitle.textContent = `${segment.id}. ${segment.title}`;
            previewSegmentAction.textContent = segment.action;
            previewSegmentPrompt.textContent = storyData.segments[index].firstFramePrompt;
        }
    }

    async function loadTaskHistory() {
        taskHistoryList.innerHTML = '';
        historyLoading.style.display = 'block';
        const newProjectCard = document.createElement('div');
        newProjectCard.className = 'entry-card new-project-card rounded-xl p-6 flex flex-col items-center justify-center text-center h-48';
        newProjectCard.innerHTML = `<div class="card-content"> <svg class="w-16 h-16 text-indigo-400 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> <h3 class="font-bold text-xl text-white">åˆ›å»ºæ–°å†…å®¹</h3> <p class="text-gray-400 text-sm mt-2">å¼€å§‹ä¸€ä¸ªå…¨æ–°çš„åˆ›ä½œä¹‹æ—…</p> </div>`;
        newProjectCard.addEventListener('click', startNewWorkflow);
        taskHistoryList.appendChild(newProjectCard);
        const tasks = await apiCall('/tasks', 'GET');
        historyLoading.style.display = 'none';
        if (tasks && tasks.length > 0) {
            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'entry-card task-history-item rounded-xl p-6 flex flex-col justify-end h-48';
                taskCard.dataset.taskName = task.folder_name;
                if (task.preview_image_url) {
                    taskCard.style.backgroundImage = `url('${task.preview_image_url}')`;
                    taskCard.classList.add('has-bg');
                }
                taskCard.innerHTML = `<div class="card-content"> <h3 class="font-bold text-xl text-white truncate">${task.title}</h3> <p class="text-gray-300 text-sm mt-1">ç‚¹å‡»åŠ è½½æ­¤é¡¹ç›®</p> </div>`;
                taskCard.addEventListener('click', (e) => handleLoadTask(e));
                taskHistoryList.appendChild(taskCard);
            });
        }
    }

    async function handleLoadTask(event) {
        const card = event.currentTarget;
        document.querySelectorAll('.active-project-card').forEach(c => c.classList.remove('active-project-card'));
        card.classList.add('active-project-card');
        const taskName = card.dataset.taskName;
        const pElement = card.querySelector('.card-content p');
        const originalText = pElement.textContent;
        pElement.textContent = 'åŠ è½½ä¸­...';
        const projectData = await apiCall(`/task/${taskName}`, 'GET');
        pElement.textContent = originalText;
        if (projectData) {
            globalBrief = projectData.brief;
            storyData = projectData.story;
            previewImageResults = projectData.images.image_urls;
            renderBrief(globalBrief);
            renderStory(storyData);
            if (previewImageResults && previewImageResults.length > 0) {
                renderPreviews(previewImageResults);
            } else {
                previewGallery.classList.add('hidden');
                step3.classList.remove('hidden');
            }
            showWorkflowView(projectData.story.title);
        } else {
            card.classList.remove('active-project-card');
        }
    }

    // --- äº‹ä»¶ç›‘å¬å™¨ ---
    generateBriefBtn.addEventListener('click', handleGenerateBrief);
    generateStoryBtn.addEventListener('click', handleGenerateStory);
    generatePreviewBtn.addEventListener('click', openConfirmationModal);
    modalConfirmBtn.addEventListener('click', confirmAndGenerateImages);
    modalCancelBtn.addEventListener('click', closeConfirmationModal);
    loadTaskHistory();
});
</script>
</body>
</html>