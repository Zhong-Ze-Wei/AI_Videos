<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼æ¼”é©¾é©¶èˆ± - ä¸“ä¸šå·¥ä½œæµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #030712; color: #F9FAFB; }
        .step-section { background-color: rgba(17, 24, 39, 0.7); backdrop-filter: blur(10px); border: 1px solid #374151; }
        .control-btn { transition: all 0.3s ease; }
        .control-btn:disabled { background-color: #4B5563; cursor: not-allowed; }
        .brief-card { background-color: #1F2937; border: 1px solid #4B5563; }
        .prompt-text { scrollbar-width: thin; scrollbar-color: #4B5563 #1F2937; }
        .prompt-text::-webkit-scrollbar { width: 8px; }
        .prompt-text::-webkit-scrollbar-track { background: #1F2937; }
        .prompt-text::-webkit-scrollbar-thumb { background-color: #4B5563; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        .segment-nav-item { transition: all 0.2s ease-in-out; border-left: 4px solid transparent; }
        .segment-nav-item:hover { background-color: #374151; border-left-color: #4338CA; }
        .segment-nav-item.active { background-color: #1E1B4B; border-left-color: #4F46E5; }
        #segment-detail-view { transition: opacity 0.3s ease-in-out; }

        #main-preview-image { transition: opacity 0.3s ease-in-out; }
        .gallery-thumbnail { cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease-in-out; opacity: 0.6; }
        .gallery-thumbnail:hover { opacity: 1; transform: scale(1.05); }
        .gallery-thumbnail.active { border-color: #4F46E5; opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-screen-2xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-black text-white tracking-tight">å¯¼æ¼”é©¾é©¶èˆ±</h1>
            <p class="text-xl text-gray-400 mt-3">ä¸“ä¸šåˆ›ä½œå·¥ä½œæµ</p>
        </header>

        <!-- æ­¥éª¤ä¸€ï¼šå…¨å±€åˆ›æ„ç®€æŠ¥ -->
        <section id="step1" class="step-section p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬ä¸€æ­¥ï¼šå…¨å±€åˆ›æ„ç®€æŠ¥</h2>
            <p class="text-gray-400 mb-6">è¾“å…¥æ ¸å¿ƒå®šä½è¯ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†çš„åˆ›ä½œåŸºçŸ³ã€‚è¿™æ˜¯ä¿è¯é£æ ¼å’Œäººç‰©ç»Ÿä¸€çš„å…³é”®ã€‚</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="style-keyword" placeholder="æ ¸å¿ƒç¾æœ¯é£æ ¼ (å¦‚ï¼šèµ›åšæœ‹å…‹æ°´å¢¨é£)" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <input type="text" id="character-keyword" placeholder="æ ¸å¿ƒè§’è‰²æè¿° (å¦‚ï¼šå‚²å¨‡ç”·ä¸»æ—æ³½å³°ï¼Œå¸…æ°”å¥³ä¸»ä¸œåŒ—é›¨å§)" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <input type="text" id="world-keyword" placeholder="æ ¸å¿ƒä¸–ç•Œè§‚ (å¦‚ï¼šå¤šé›¨çš„äºšæ´²å·¨å‹éƒ½å¸‚)" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
            </div>
            <button id="generate-brief-btn" class="control-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆåˆ›æ„ç®€æŠ¥</button>
            <div id="brief-display" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6"></div>
        </section>

        <!-- æ­¥éª¤äºŒï¼šæ•…äº‹å¤§çº²ä¸ç»†èŠ‚ -->
        <section id="step2" class="step-section p-6 rounded-xl mb-8 hidden">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬äºŒæ­¥ï¼šæ•…äº‹å¤§çº²ä¸ç»†èŠ‚</h2>
            <p class="text-gray-400 mb-6">åŸºäºå·²ç¡®å®šçš„åˆ›æ„ç®€æŠ¥ï¼Œè¾“å…¥æ•…äº‹ä¸»é¢˜ï¼ŒAIå°†ç”ŸæˆåŒ…å«å®Œæ•´å‰§æœ¬å’Œæç¤ºè¯çš„6ä¸ªå­æ®µè½ã€‚</p>
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" id="theme-input" placeholder="è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜ (å¦‚ï¼šè¿½æŸ¥ä¸€ä¸ªå¤åˆ¶äººå¤±è¸ªæ¡ˆ)" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <button id="generate-story-btn" class="control-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆæ•…äº‹å‰§æœ¬</button>
            </div>
            <div id="story-display" class="grid grid-cols-1 lg:grid-cols-4 gap-8 mt-6 hidden">
                <div id="segment-detail-view" class="lg:col-span-3 space-y-6"></div>
                <div id="segment-navigation" class="lg:col-span-1 space-y-2"></div>
            </div>
        </section>

        <!-- æ­¥éª¤ä¸‰ï¼šè§†è§‰é¢„è§ˆ -->
        <section id="step3" class="step-section p-6 rounded-xl hidden">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-3">ç¬¬ä¸‰æ­¥ï¼šè§†è§‰é¢„è§ˆ</h2>
            <p class="text-gray-400 mb-6">é¢„è§ˆæ ¹æ®æç¤ºè¯ç”Ÿæˆçš„å…³é”®å¸§å›¾åƒï¼Œæ£€æŸ¥é£æ ¼ã€äººç‰©çš„ä¸€è‡´æ€§ï¼Œç¡®è®¤æ— è¯¯åå†è¿›è¡Œæœ€ç»ˆçš„è§†é¢‘ç”Ÿæˆã€‚</p>
            <button id="generate-preview-btn" class="control-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg">ç”Ÿæˆå…¨éƒ¨é¢„è§ˆå›¾</button>
            <div id="preview-gallery" class="mt-6 hidden">
                <div id="main-preview-wrapper" class="mb-4 bg-black rounded-lg aspect-video overflow-hidden">
                    <img id="main-preview-image" src="" alt="ä¸»é¢„è§ˆå›¾" class="w-full h-full object-contain">
                </div>
                <div id="thumbnail-strip" class="grid grid-cols-3 md:grid-cols-6 gap-3"></div>
            </div>
        </section>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- å…¨å±€çŠ¶æ€ ---
    let globalBrief = {};
    let storyData = {};
    let activeChart = null;

    // --- DOM å…ƒç´  ---
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const generateBriefBtn = document.getElementById('generate-brief-btn');
    const briefDisplay = document.getElementById('brief-display');
    const generateStoryBtn = document.getElementById('generate-story-btn');
    const storyDisplay = document.getElementById('story-display');
    const detailView = document.getElementById('segment-detail-view');
    const navigation = document.getElementById('segment-navigation');
    const generatePreviewBtn = document.getElementById('generate-preview-btn');
    const previewGallery = document.getElementById('preview-gallery');
    const mainPreviewImage = document.getElementById('main-preview-image');
    const thumbnailStrip = document.getElementById('thumbnail-strip');

    // --- API è°ƒç”¨å‡½æ•° ---
    async function apiCall(endpoint, body, button) {
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'ç”Ÿæˆä¸­...';
        try {
            const response = await fetch(`http://127.0.0.1:8000${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.detail || 'æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯');
            }
            return await response.json();
        } catch (error) {
            alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            return null;
        } finally {
            button.disabled = false;
            button.textContent = originalText;
        }
    }

    // --- æ­¥éª¤ä¸€ï¼šç”Ÿæˆåˆ›æ„ç®€æŠ¥ ---
    async function handleGenerateBrief() {
        const keywords = {
            style: document.getElementById('style-keyword').value,
            character: document.getElementById('character-keyword').value,
            world: document.getElementById('world-keyword').value,
        };
        if (!keywords.style || !keywords.character || !keywords.world) {
            alert('è¯·å¡«å†™å…¨éƒ¨ä¸‰ä¸ªæ ¸å¿ƒå®šä½è¯ï¼'); return;
        }

        const result = await apiCall('/generate_brief', keywords, generateBriefBtn);
        if (result) {
            globalBrief = result;
            renderBrief(globalBrief);
        }
    }

    function renderBrief(brief) {
        briefDisplay.innerHTML = `
            <div class="brief-card p-4 rounded-lg fade-in"><h3 class="font-bold text-lg text-indigo-400 mb-2">ç¾æœ¯é£æ ¼</h3><p class="text-gray-300 text-sm">${brief.style.replace(/\n/g, '<br>')}</p></div>
            <div class="brief-card p-4 rounded-lg fade-in" style="animation-delay: 0.1s;"><h3 class="font-bold text-lg text-green-400 mb-2">è§’è‰²æè¿°</h3><p class="text-gray-300 text-sm">${brief.character.replace(/\n/g, '<br>')}</p></div>
            <div class="brief-card p-4 rounded-lg fade-in" style="animation-delay: 0.2s;"><h3 class="font-bold text-lg text-amber-400 mb-2">ä¸–ç•Œè§‚</h3><p class="text-gray-300 text-sm">${brief.world.replace(/\n/g, '<br>')}</p></div>
        `;
        step2.classList.remove('hidden');
        step2.classList.add('fade-in');
    }

    // --- æ­¥éª¤äºŒï¼šç”Ÿæˆæ•…äº‹å‰§æœ¬ ---
    async function handleGenerateStory() {
        const theme = document.getElementById('theme-input').value;
        if (!theme) { alert('è¯·è¾“å…¥æ•…äº‹ä¸»é¢˜ï¼'); return; }

        const result = await apiCall('/generate_story_details', { brief: globalBrief, theme: theme }, generateStoryBtn);
        if (result) {
            storyData = result;
            renderStory(storyData);
        }
    }

    function renderStory(story) {
        storyDisplay.classList.remove('hidden');
        renderNavigation(story.segments);
        updateDetailView(story.segments[0].id); // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€å¹•
        step3.classList.remove('hidden');
        step3.classList.add('fade-in');
    }

    function renderNavigation(segments) {
        navigation.innerHTML = '';
        segments.forEach(segment => {
            const navItem = document.createElement('div');
            navItem.className = 'segment-nav-item p-3 rounded-md cursor-pointer';
            navItem.dataset.id = segment.id;
            navItem.innerHTML = `<h4 class="font-bold text-white">${segment.id}. ${segment.title}</h4>`;
            navItem.addEventListener('click', () => updateDetailView(segment.id));
            navigation.appendChild(navItem);
        });
    }

    function updateDetailView(segmentId) {
        const segment = storyData.segments.find(s => s.id === segmentId);
        if (!segment) return;

        document.querySelectorAll('.segment-nav-item').forEach(item => {
            item.classList.toggle('active', parseInt(item.dataset.id) === segmentId);
        });

        detailView.style.opacity = 0;
        setTimeout(() => {
            detailView.innerHTML = `
                <div class="brief-card p-6 rounded-lg"><h3 class="text-2xl font-bold text-white mb-3">${segment.id}. ${segment.title}</h3><p class="text-gray-300 leading-relaxed">${segment.action}</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="brief-card p-4 rounded-lg space-y-4">
                        <h4 class="font-semibold text-gray-200 text-lg border-b border-gray-600 pb-2">æ•°æ®åˆ†æå°</h4>
                        ${createDataBar('å™äº‹å¼ åŠ›', segment.analytics.tension, 'bg-indigo-500')}
                        ${createDataBar('è§†è§‰å¤æ‚åº¦', segment.analytics.complexity, 'bg-green-500')}
                        ${createDataBar('å™äº‹èŠ‚å¥', segment.analytics.pacing, 'bg-amber-500')}
                        <div><h5 class="font-semibold text-gray-300 mb-2 text-center">æƒ…æ„Ÿå…‰è°±</h5><div class="h-48"><canvas id="detail-chart"></canvas></div></div>
                    </div>
                    <div class="brief-card p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-200 text-lg border-b border-gray-600 pb-2">AIç”ŸæˆæŒ‡ä»¤</h4>
                        <h5 class="font-semibold text-gray-300 mt-4 mb-2">ğŸ–¼ï¸ å›¾åƒæç¤ºè¯</h5><p class="prompt-text text-sm text-gray-400 h-24 overflow-y-auto bg-gray-800 p-2 rounded">${segment.firstFramePrompt}</p>
                        <h5 class="font-semibold text-gray-300 mt-4 mb-2">ğŸ¥ è§†é¢‘æç¤ºè¯</h5><p class="prompt-text text-sm text-gray-400 h-24 overflow-y-auto bg-gray-800 p-2 rounded">${segment.videoPrompt}</p>
                    </div>
                </div>
            `;
            if (activeChart) activeChart.destroy();
            const ctx = document.getElementById('detail-chart').getContext('2d');
            activeChart = new Chart(ctx, { type: 'radar', data: { labels: Object.keys(segment.analytics.emotion), datasets: [{ label: 'æƒ…æ„Ÿ', data: Object.values(segment.analytics.emotion), backgroundColor: 'rgba(239, 68, 68, 0.2)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1.5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { angleLines: { color: '#4B5563' }, grid: { color: '#4B5563' }, pointLabels: { color: '#D1D5DB', font: { size: 12 } }, suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } } } });
            detailView.style.opacity = 1;
        }, 300);
    }

    function createDataBar(label, value, colorClass) {
        const percentage = (value / 10) * 100;
        return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-300">${label}</span><span class="text-sm font-bold text-white">${value.toFixed(1)}</span></div><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
    }

    // --- æ­¥éª¤ä¸‰ï¼šç”Ÿæˆè§†è§‰é¢„è§ˆ ---
    async function handleGeneratePreviews() {
        if (!storyData.segments || storyData.segments.length === 0) {
            alert('è¯·å…ˆç”Ÿæˆæ•…äº‹å‰§æœ¬ï¼'); return;
        }

        // æ ¹æ®åç«¯ä»£ç ï¼Œæ¯ä¸€å¹•åªç”Ÿæˆä¸€å¼ å›¾
        generatePreviewBtn.textContent = `ç”Ÿæˆå…¨éƒ¨é¢„è§ˆå›¾ (${storyData.segments.length}å¼ )`;

        const payload = {
            brief: globalBrief,
            segments: storyData.segments
        };
        const result = await apiCall('/generate_images', payload, generatePreviewBtn);

        if (result && result.image_urls) {
            renderPreviews(result.image_urls);
        }
    }

    function renderPreviews(urls) {
        previewGallery.classList.remove('hidden');
        thumbnailStrip.innerHTML = '';
        mainPreviewImage.src = urls[0];
        urls.forEach((url, index) => {
            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'gallery-thumbnail aspect-video bg-gray-800 rounded-lg overflow-hidden';
            thumbWrapper.dataset.src = url;
            const img = document.createElement('img');
            img.src = url;
            img.className = 'w-full h-full object-cover';
            img.alt = `é¢„è§ˆå›¾ ${index + 1}`;
            img.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x225/030712/F9FAFB?text=Error'; };
            thumbWrapper.appendChild(img);
            thumbnailStrip.appendChild(thumbWrapper);
            if (index === 0) thumbWrapper.classList.add('active');
            thumbWrapper.addEventListener('click', () => switchMainImage(thumbWrapper));
        });
    }

    function switchMainImage(clickedThumb) {
        const currentActive = thumbnailStrip.querySelector('.active');
        if (currentActive === clickedThumb) return;
        if (currentActive) currentActive.classList.remove('active');
        clickedThumb.classList.add('active');
        mainPreviewImage.style.opacity = 0;
        setTimeout(() => {
            mainPreviewImage.src = clickedThumb.dataset.src;
            mainPreviewImage.style.opacity = 1;
        }, 300);
    }

    // --- äº‹ä»¶ç»‘å®š ---
    generateBriefBtn.addEventListener('click', handleGenerateBrief);
    generateStoryBtn.addEventListener('click', handleGenerateStory);
    generatePreviewBtn.addEventListener('click', handleGeneratePreviews);
});
</script>
</body>
</html>
